(function(){tinymce.PluginManager.load("icelib",tinymce.PluginManager.urls.ice+"/ice/ice.min.js",function(){});tinymce.create("tinymce.plugins.IcePlugin",{deleteTag:"span",insertTag:"span",deleteClass:"del",insertClass:"ins",changeIdAttribute:"data-cid",userIdAttribute:"data-userid",userNameAttribute:"data-username",timeAttribute:"data-time",preserveOnPaste:"p",user:{name:"Unknown User",id:Math.random()},isTracking:true,contentEditable:true,css:"css/ice.css",manualInit:false,afterInit:function(){},afterClean:function(a){return a},beforePasteClean:function(a){return a},afterPasteClean:function(a){return a},init:function(b,c){var a=this,h={};b.iceAfterInit=new tinymce.util.Dispatcher(a);b.iceAfterClean=new tinymce.util.Dispatcher(a);b.iceAccept=new tinymce.util.Dispatcher(a);b.iceReject=new tinymce.util.Dispatcher(a);b.iceAcceptAll=new tinymce.util.Dispatcher(a);b.iceRejectAll=new tinymce.util.Dispatcher(a);b.onInit.add(function(i){var j=i.dom;tinymce.extend(a,i.getParam("ice"));a.insertSelector="."+a.insertClass;a.deleteSelector="."+a.deleteClass;i.serializer.addRules(a.insertTag+"[id|class|style|title|username|userid|cid]");if(a.insertTag!=a.deleteTag){i.serializer.addRules(a.deleteTag+"[id|class|style|title|username|userid|cid]")}i.serializer.addRules("tempdel[data-allocation]");j.loadCSS(a.css.indexOf("://")>0?a.css:(c+"/"+a.css));if(!a.manualInit){i.execCommand("initializeice")}i.controlManager.setActive("ice_toggleshowchanges",true);if(a.isTracking){i.controlManager.setActive("ice_togglechanges",true)}});b.addCommand("initializeice",function(i){b=i||b;tinymce.DOM.win.setTimeout(function(){h=new ice.InlineChangeEditor({element:b.getBody(),isTracking:a.isTracking,contentEditable:a.contentEditable,changeIdAttribute:a.changeIdAttribute,userIdAttribute:a.userIdAttribute,userNameAttribute:a.userNameAttribute,timeAttribute:a.timeAttribute,currentUser:{id:a.user.id,name:a.user.name},plugins:["IceEmdashPlugin","IceAddTitlePlugin","IceSmartQuotesPlugin",{name:"IceCopyPastePlugin",settings:{pasteType:"formattedClean",preserve:a.preserveOnPaste,beforePasteClean:a.beforePasteClean,afterPasteClean:a.afterPasteClean}}],changeTypes:{insertType:{tag:a.insertTag,alias:a.insertClass},deleteType:{tag:a.deleteTag,alias:a.deleteClass}}}).startTracking();b.onEvent.add(function(j,k){return h.handleEvent(k)});setTimeout(function(){a.afterInit.call(a);b.iceAfterInit.dispatch(a)},1)},5)});b.addCommand("ice_initenv",function(){h.initializeEnvironment();h.initializeRange()});b.addCommand("icecleanbody",function(j){var i=h.getCleanContent(j||b.getContent(),a.afterClean);b.iceAfterClean.dispatch({body:i,scope:a});return i});b.addCommand("ice_hasDeletePlaceholders",function(){return h.isPlaceholdingDeletes});b.addCommand("ice_addDeletePlaceholders",function(){return h.placeholdDeletes()});b.addCommand("ice_removeDeletePlaceholders",function(){return h.revertDeletePlaceholders()});b.addCommand("iceinsert",function(i){i=i||{};h.insert(i.item,i.range)});b.addCommand("icedelete",function(i){i=i||{};h.deleteContents(i.right,i.range)});b.addCommand("ice_changeuser",function(i){h.setCurrentUser(i)});b.addCommand("iceaccept",function(j){var k=j||b.selection.getNode(),i=[];b.undoManager.add();b.iceAccept.dispatch({node:k,scope:a});if(d(k)){b.dom.remove(k,true)}else{if(g(k)){i.push(k.parentNode);b.dom.remove(k)}}e(i);b.execCommand("ice_initenv")});b.addCommand("icereject",function(j){var k=j||b.selection.getNode(),i=[];b.undoManager.add();b.iceReject.dispatch({node:k,scope:a});if(d(k)){i.push(k.parentNode);b.dom.remove(k)}else{if(g(k)){b.dom.remove(k,true)}}e(i);b.execCommand("ice_initenv")});b.addCommand("iceacceptall",function(){var j=b.dom.select(a.insertSelector),k=b.dom.select(a.deleteSelector),i=[];b.undoManager.add();tinymce.each(k,function(l){i.push(l.parentNode)});b.iceAcceptAll.dispatch(a);b.dom.remove(k);b.dom.remove(j,true);e(i);b.execCommand("ice_initenv")});b.addCommand("icerejectall",function(){var j=b.dom.select(a.insertSelector),k=b.dom.select(a.deleteSelector),i=[];b.undoManager.add();tinymce.each(j,function(l){i.push(l.parentNode)});b.iceRejectAll.dispatch(a);b.dom.remove(k,true);b.dom.remove(j);e(i);b.execCommand("ice_initenv")});b.addCommand("ice_toggleshowchanges",function(){var j=b.getBody(),i=b.controlManager,k=false;if(b.dom.hasClass(j,"CT-hide")){i.setActive("ice_toggleshowchanges",true);b.dom.removeClass(j,"CT-hide")}else{i.setActive("ice_toggleshowchanges",false);b.dom.addClass(j,"CT-hide");k=true}tinymce.each(["iceacceptall","icerejectall"],function(l){i.setDisabled(l,k)});b.execCommand("mceRepaint")});b.addCommand("ice_smartquotes",function(){var i=b.getBody();h.pluginsManager.plugins.IceSmartQuotesPlugin.convert(i);b.windowManager.alert("Regular quotes have been converted into smart quotes.")});b.addCommand("ice_togglechanges",function(){if(h.isTracking){b.execCommand("ice_disable")}else{b.execCommand("ice_enable")}});b.addCommand("ice_enable",function(){h.enableChangeTracking();b.controlManager.setActive("ice_togglechanges",true);a.isTracking=true});b.addCommand("ice_disable",function(){h.disableChangeTracking();b.controlManager.setActive("ice_togglechanges",false);a.isTracking=false});b.addCommand("ice_isTracking",function(){return h.isTracking?1:0});b.addCommand("ice_strippaste",function(i){return h.pluginsManager.plugins.IceCopyPastePlugin.stripPaste(i)});b.addButton("iceaccept",{title:"Accept Change",image:c+"/img/ice-accept-change.png",cmd:"iceaccept"});b.addButton("icereject",{title:"Reject Change",image:c+"/img/ice-reject-change.png",cmd:"icereject"});b.addButton("iceacceptall",{title:"Accept All Changes",image:c+"/img/ice-accept.png",cmd:"iceacceptall"});b.addButton("icerejectall",{title:"Reject All Changes",image:c+"/img/ice-reject.png",cmd:"icerejectall"});b.addButton("ice_toggleshowchanges",{title:"Show Track Changes",image:c+"/img/ice-showchanges.png",cmd:"ice_toggleshowchanges"});b.addButton("ice_smartquotes",{title:"Convert quotes to smart quotes","class":"mce_blockquote",cmd:"ice_smartquotes"});b.addButton("ice_togglechanges",{title:"Turn On Track Changes ",image:c+"/img/ice-togglechanges.png",cmd:"ice_togglechanges"});if(b.plugins.contextmenu){b.plugins.contextmenu.onContextMenu.add(function(j,k,i){if(f(i)){k.add({title:"<img src='"+c+"/img/ice-accept-change.png' style='vertical-align: middle;margin-left: -22px;margin-right: 5px;'>Accept Change",icon:"",cmd:"iceaccept"});k.add({title:"<img src='"+c+"/img/ice-reject-change.png' style='vertical-align: middle;margin-left: -22px;margin-right: 5px;'>Reject Change",icon:"",cmd:"icereject"})}})}b.onNodeChange.add(function(j,i,k){if(f(k)){i.setDisabled("iceaccept",false);i.setDisabled("icereject",false);e()}else{i.setDisabled("iceaccept",true);i.setDisabled("icereject",true)}});function f(i){return !!b.dom.getParent(i,a.insertSelector+","+a.deleteSelector)}function d(i){return b.dom.is(i,a.insertSelector)}function g(i){return b.dom.is(i,a.deleteSelector)}function e(i){var j=b.dom.select(a.insertSelector+":empty,"+a.deleteSelector+":empty");i=i||[];if(j&&j[0]){tinymce.each(j,function(k){i.push(k.parentNode)});b.dom.remove(j)}if(i&&i[0]){tinymce.each(i,function(k){if(b.dom.is(k,"p:empty, li:empty, span:empty, div:empty")){b.dom.remove(k)}})}}}});tinymce.PluginManager.add("ice",tinymce.plugins.IcePlugin)})();